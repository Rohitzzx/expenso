<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Expenso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { font-family: 'Inter', sans-serif; }
    
    .bg-primary-gradient {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    
    .text-primary {
      color: #059669;
    }
    
    .border-primary {
      border-color: #059669;
    }

    .table-row-hover:hover {
      background-color: #f9fafb;
    }
    
    .tag-Food { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .tag-Travel { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    .tag-Rent { background-color: #f5f3ff; color: #7c3aed; border: 1px solid #ddd6fe; }
    .tag-Groceries { background-color: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .tag-Shopping { background-color: #fdf2f8; color: #db2777; border: 1px solid #fbcfe8; }
    .tag-Bills { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .tag-Entertainment { background-color: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
    .tag-Others { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
    
    .card-hover {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
    }
    
    .filter-btn {
      transition: all 0.2s ease;
    }
    .filter-btn.active {
      background-color: #059669;
      color: white;
      border-color: #059669;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen selection:bg-green-100 selection:text-green-900">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-md border-b border-gray-200 fixed w-full top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-green-600 rounded flex items-center justify-center">
            <span class="text-white font-bold text-lg">E</span>
          </div>
          <h1 class="text-xl font-bold text-gray-900 tracking-tight">expenso</h1>
        </div>
        
        <nav class="hidden md:flex items-center space-x-8">
          <a href="index.html" class="text-gray-500 hover:text-gray-900 transition-colors font-medium">Home</a>
          <a href="dashboard.html" class="text-green-600 font-medium">Dashboard</a>
          <a href="add_expence.html" class="text-gray-500 hover:text-gray-900 transition-colors font-medium">Add Expense</a>
          <a href="report.html" class="text-gray-500 hover:text-gray-900 transition-colors font-medium">Reports</a>
          <a href="profile.html" class="text-gray-500 hover:text-gray-900 transition-colors font-medium">Profile</a>
          <button onclick="window.logout()" class="text-gray-500 hover:text-red-600 font-medium transition-colors">
            <i class="fa-solid fa-arrow-right-from-bracket mr-1.5"></i>Logout
          </button>
        </nav>

        <button class="md:hidden text-gray-500 hover:text-gray-900" onclick="toggleMobileMenu()">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
      </div>

      <div id="mobile-menu" class="hidden md:hidden mt-4 pb-2 border-t border-gray-100 pt-4">
        <div class="flex flex-col space-y-4">
          <a href="index.html" class="text-gray-600 font-medium">Home</a>
          <a href="dashboard.html" class="text-green-600 font-medium">Dashboard</a>
          <a href="add_expence.html" class="text-gray-600 font-medium">Add Expense</a>
          <a href="report.html" class="text-gray-600 font-medium">Reports</a>
          <a href="profile.html" class="text-gray-600 font-medium">Profile</a>
          <button onclick="window.logout()" class="text-left text-red-600 font-medium pt-2 border-t border-gray-100">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-28 px-4 pb-12 max-w-7xl mx-auto">
    <!-- Welcome Section -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-900" id="welcome-msg">Dashboard</h2>
        <p class="text-gray-500 mt-1">Here's a snapshot of your financial activity.</p>
      </div>
      <div class="flex gap-3">
        <button onclick="exportToCSV()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm flex items-center">
          <i class="fa-solid fa-download mr-2 text-gray-400"></i> Export
        </button>
        <a href="add_expence.html" class="bg-primary-gradient text-white px-4 py-2 rounded-lg hover:shadow-md transition-shadow font-medium text-sm flex items-center">
          <i class="fa-solid fa-plus mr-2"></i> New Expense
        </a>
      </div>
    </div>

    <!-- Time Range Filter -->
    <div class="mb-8">
      <div class="flex items-center gap-2 mb-3">
        <i class="fa-regular fa-clock text-gray-400"></i>
        <span class="text-sm font-medium text-gray-700">Time Range:</span>
      </div>
      <div class="flex flex-wrap gap-2">
        <button onclick="setTimeFilter('24h')" class="filter-btn px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-green-500 hover:text-green-700 transition-colors" id="filter-24h">Last 24h</button>
        <button onclick="setTimeFilter('7d')" class="filter-btn px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-green-500 hover:text-green-700 transition-colors" id="filter-7d">Last 7 days</button>
        <button onclick="setTimeFilter('30d')" class="filter-btn px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-green-500 hover:text-green-700 transition-colors active" id="filter-30d">Last 30 days</button>
        <button onclick="setTimeFilter('90d')" class="filter-btn px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-green-500 hover:text-green-700 transition-colors" id="filter-90d">Last 90 days</button>
        <button onclick="setTimeFilter('1y')" class="filter-btn px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-green-500 hover:text-green-700 transition-colors" id="filter-1y">Last year</button>
        <button onclick="setTimeFilter('lifetime')" class="filter-btn px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-green-500 hover:text-green-700 transition-colors" id="filter-lifetime">Lifetime</button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">Total Spent</h3>
          <i class="fa-solid fa-chart-simple text-gray-400"></i>
        </div>
        <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-total">₹0</p>
        <p class="text-xs text-gray-400 mt-2" id="stat-period">for selected period</p>
      </div>

      <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">Transactions</h3>
          <i class="fa-solid fa-receipt text-gray-400"></i>
        </div>
        <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-count">0</p>
        <p class="text-xs text-gray-400 mt-2">total entries</p>
      </div>

      <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">Daily Average</h3>
          <i class="fa-solid fa-chart-line text-gray-400"></i>
        </div>
        <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-average">₹0</p>
        <p class="text-xs text-gray-400 mt-2">per day</p>
      </div>

      <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">Top Category</h3>
          <i class="fa-solid fa-crown text-gray-400"></i>
        </div>
        <p class="text-xl font-bold text-gray-900 mt-2 truncate" id="stat-category">-</p>
        <p class="text-xs text-gray-400 mt-2">highest spending</p>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Recent Transactions Table -->
      <div class="lg:col-span-2 bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-200 flex items-center justify-between bg-white">
          <h3 class="font-semibold text-gray-900">Recent Transactions</h3>
          <span class="text-xs text-gray-500 font-medium">Showing for selected period</span>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left">
            <thead class="bg-gray-50 text-gray-500 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 font-medium">Date</th>
                <th class="px-6 py-3 font-medium">Description</th>
                <th class="px-6 py-3 font-medium">Category</th>
                <th class="px-6 py-3 font-medium text-right">Amount</th>
                <th class="px-6 py-3 font-medium text-center">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-900 mb-6">Spending Breakdown</h3>
        <div class="h-64 relative flex items-center justify-center">
          <canvas id="expenseChart"></canvas>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-100 text-center text-sm font-medium text-gray-500" id="chart-summary">
          No data to visualize
        </div>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    let currentFilter = '30d'; // Default filter
    let allExpenses = [];
    
    function toggleMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('hidden');
    }

    if (typeof requireAuth === 'function') requireAuth();
    
    const user = (typeof getLoggedInUser === 'function') ? getLoggedInUser() : null;
    if(user && user.name) {
      document.getElementById('welcome-msg').innerText = `Welcome back, ${user.name.split(' ')[0]}`;
    }

    if (typeof formatCurrency !== 'function') {
      window.formatCurrency = function(amount) {
        return `₹${parseFloat(amount).toLocaleString('en-IN')}`;
      }
    }

    // Load all expenses
    function loadAllExpenses() {
      allExpenses = (typeof getUserExpenses === 'function') ? getUserExpenses() : [];
    }

    // Filter expenses based on time range
    function filterExpensesByTime(expenses, filter) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      return expenses.filter(exp => {
        const expDate = new Date(exp.date);
        
        switch(filter) {
          case '24h':
            const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            return expDate >= oneDayAgo;
          
          case '7d':
            const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            return expDate >= sevenDaysAgo;
          
          case '30d':
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            return expDate >= thirtyDaysAgo;
          
          case '90d':
            const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
            return expDate >= ninetyDaysAgo;
          
          case '1y':
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            return expDate >= oneYearAgo;
          
          case 'lifetime':
            return true; // All expenses
          
          default:
            return true;
        }
      });
    }

    // Calculate daily average
    function calculateDailyAverage(expenses, filter) {
      if (expenses.length === 0) return 0;
      
      const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      let days = 0;
      
      switch(filter) {
        case '24h':
          days = 1;
          break;
        case '7d':
          days = 7;
          break;
        case '30d':
          days = 30;
          break;
        case '90d':
          days = 90;
          break;
        case '1y':
          days = 365;
          break;
        case 'lifetime':
          // Calculate actual days from first expense to now
          if (expenses.length === 0) return 0;
          const dates = expenses.map(e => new Date(e.date));
          const oldest = new Date(Math.min(...dates));
          const now = new Date();
          const diffTime = Math.abs(now - oldest);
          days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
          break;
        default:
          days = 30;
      }
      
      return total / days;
    }

    // Update active filter button
    function updateActiveFilter(filter) {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-green-600', 'text-white', 'border-green-600');
        btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
      });
      
      const activeBtn = document.getElementById(`filter-${filter}`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        activeBtn.classList.add('active', 'bg-green-600', 'text-white', 'border-green-600');
      }
    }

    // Set time filter
    function setTimeFilter(filter) {
      currentFilter = filter;
      updateActiveFilter(filter);
      
      const filteredExpenses = filterExpensesByTime(allExpenses, filter);
      updateDashboard(filteredExpenses);
      
      // Update period text
      const periodText = {
        '24h': 'last 24 hours',
        '7d': 'last 7 days',
        '30d': 'last 30 days',
        '90d': 'last 90 days',
        '1y': 'last year',
        'lifetime': 'all time'
      };
      document.getElementById('stat-period').innerText = `for ${periodText[filter]}`;
    }

    function updateDashboard(expenses) {
      expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      let totalOverall = 0;
      const catTotals = {};
      const tbody = document.getElementById('table-body');
      
      tbody.innerHTML = '';
      
      expenses.slice(0, 10).forEach(exp => {
        totalOverall += exp.amount;
        catTotals[exp.category] = (catTotals[exp.category] || 0) + exp.amount;

        const safeCategoryClass = exp.category ? exp.category.replace(/\s+/g, '') : 'Others';

        tbody.innerHTML += `
          <tr class="table-row-hover">
            <td class="px-6 py-4 text-gray-500">${new Date(exp.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })}</td>
            <td class="px-6 py-4 font-medium text-gray-900">${exp.title}</td>
            <td class="px-6 py-4">
              <span class="inline-block px-2.5 py-1 rounded text-xs font-semibold tag-${safeCategoryClass}">
                ${exp.category}
              </span>
            </td>
            <td class="px-6 py-4 font-semibold text-gray-900 text-right">${formatCurrency(exp.amount)}</td>
            <td class="px-6 py-4 text-center">
              <button onclick="deleteExpense(${exp.id})" class="text-gray-400 hover:text-red-600 transition-colors p-1">
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </td>
          </tr>
        `;
      });

      if(expenses.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-12 text-center text-gray-400">
              No transactions for this period. <a href="add_expence.html" class="text-green-600 hover:underline">Add an expense</a>
            </td>
          </tr>
        `;
      }

      let topCat = "—";
      if (Object.keys(catTotals).length > 0) {
        topCat = Object.keys(catTotals).reduce((a, b) => catTotals[a] > catTotals[b] ? a : b);
      }

      const dailyAverage = calculateDailyAverage(expenses, currentFilter);

      document.getElementById('stat-total').innerText = formatCurrency(totalOverall);
      document.getElementById('stat-count').innerText = expenses.length;
      document.getElementById('stat-average').innerText = formatCurrency(Math.round(dailyAverage));
      document.getElementById('stat-category').innerText = topCat;

      updateChart(catTotals, totalOverall);
    }

    function updateChart(catTotals, totalOverall) {
      let chartStatus = Chart.getChart("expenseChart");
      if (chartStatus) chartStatus.destroy();

      const chartSummary = document.getElementById('chart-summary');

      if (Object.keys(catTotals).length > 0) {
        chartSummary.innerHTML = `Total: <span class="text-gray-900 font-bold">${formatCurrency(totalOverall)}</span>`;

        new Chart(document.getElementById('expenseChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(catTotals),
            datasets: [{
              data: Object.values(catTotals),
              backgroundColor: ['#059669', '#3b82f6', '#8b5cf6', '#f59e0b', '#ec4899', '#0ea5e9', '#64748b'],
              borderWidth: 2,
              borderColor: '#ffffff',
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: { usePointStyle: true, padding: 20, font: { size: 12 } }
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.raw;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return ` ${formatCurrency(value)} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      } else {
        chartSummary.innerHTML = 'No data to visualize';
      }
    }

    window.deleteExpense = function(expenseId) {
      if(confirm("Delete this transaction?")) {
        let allExpenses = JSON.parse(localStorage.getItem('expenses')) || [];
        allExpenses = allExpenses.filter(exp => exp.id !== expenseId);
        localStorage.setItem('expenses', JSON.stringify(allExpenses));
        
        // Reload all expenses and reapply filter
        loadAllExpenses();
        const filteredExpenses = filterExpensesByTime(allExpenses, currentFilter);
        updateDashboard(filteredExpenses);
      }
    }

    function exportToCSV() {
      const filteredExpenses = filterExpensesByTime(allExpenses, currentFilter);
      if (filteredExpenses.length === 0) { 
        alert("No data to export for this period.");
        return; 
      }
      
      const headers = ["Date", "Description", "Category", "Amount"];
      const rows = filteredExpenses.map(exp => `"${exp.date}","${exp.title}","${exp.category}","${exp.amount}"`);
      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      
      const period = currentFilter;
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `Expenso_${period}_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // Initialize
    loadAllExpenses();
    setTimeFilter('30d'); // Default to last 30 days
  </script>
</body>
</html>